<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K√≥dkeres≈ë</title>
<style>
html, body { margin:0; padding:0; height:100%; font-family: Arial; background:#0a0a0a; color:white; overflow:hidden; }
#reader { width:100vw; height:100vh; position:fixed; top:0; left:0; z-index:0; }
#overlay { position:fixed; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background:rgba(0,0,0,0.5); z-index:2; }
button { background:#007bff; border:none; color:white; font-size:24px; padding:15px 40px; border-radius:12px; cursor:pointer; margin-top:20px; }
button:hover { background:#0056b3; }
#result { font-size:60px; font-weight:bold; color:#00ff88; text-align:center; word-wrap:break-word; margin-bottom:30px; }
</style>
</head>
<body>

<div id="reader"></div>
<div id="overlay">
  <div id="result">Kamera ind√≠t√°sra v√°r...</div>
  <button id="scanButton">üì∑ √öj beolvas√°s</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const GITHUB_RAW_URL = "https://raw.githubusercontent.com/hunyadvariarmin/kodkereso-pwa/main/adatok.xlsx";
let data = [];
let html5QrCode;

// --- Excel bet√∂lt√©se ---
async function loadExcel() {
  try {
    const resp = await fetch(GITHUB_RAW_URL);
    if (!resp.ok) throw new Error("Excel bet√∂lt√©si hiba!");
    const buffer = await resp.arrayBuffer();
    const wb = XLSX.read(buffer, {type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    data = XLSX.utils.sheet_to_json(sheet, {header:1});
    console.log("‚úÖ Excel bet√∂ltve:", data.slice(0,5));
  } catch(e) {
    console.error("‚ùå Excel bet√∂lt√©si hiba:", e);
    document.getElementById("result").innerText = "Excel bet√∂lt√©si hiba!";
  }
}

// --- Normaliz√°l√≥ f√ºggv√©ny ---
function normalizeCode(str) {
  if(!str) return "";
  str = String(str).trim().toUpperCase()
    .replace(/\s+/g,'')
    .replace(/[‚Äê-‚Äì‚Äî‚àí]/g,'-')
    .replace(/\\/g,'/')
    .replace(/[^A-Z0-9\-\/]/g,'');
  if(str.includes("/")) str = str.split("/")[0]; // lev√°gja a / ut√°ni r√©szt
  if(/^\d+\.0$/.test(str)) str = str.replace(/\.0$/,'');
  return str;
}

// --- Keres√©s ---
function findValueByCode(code) {
  if(!code || !data.length) return "Nincs tal√°lat!";
  const searchCode = normalizeCode(code);
  console.log("üîπ Normaliz√°lt k√≥d:", searchCode);
  for(let i=1;i<data.length;i++){
    if(!data[i] || data[i].length<2) continue;
    const cellValue = normalizeCode(data[i][0]);
    console.log("üß© √ñsszehasonl√≠t√°s:", cellValue,"==",searchCode);
    if(cellValue === searchCode) return data[i][1];
  }
  return "Nincs tal√°lat!";
}

// --- Kamera ind√≠t√°sa ---
async function startCamera() {
  try {
    if(html5QrCode) {
      await html5QrCode.stop().catch(()=>{});
      document.getElementById("reader").innerHTML = "";
    }
    html5QrCode = new Html5Qrcode("reader");
    await html5QrCode.start(
      { facingMode:"environment" },
      { fps:10, qrbox:{width:window.innerWidth,height:window.innerHeight} },
      onScanSuccess
    );
    document.getElementById("result").innerText = "Kamera akt√≠v ‚Äì olvass be egy k√≥dot!";
  } catch(e) {
    console.error("‚ùå Kamera hiba:",e);
    document.getElementById("result").innerText = "Kamera ind√≠t√°sa nem siker√ºlt!";
  }
}

// --- Beolvas√°s callback ---
function onScanSuccess(decodedText){
  console.log("üì∑ Beolvasott k√≥d (eredeti):", decodedText);
  const value = findValueByCode(decodedText);
  document.getElementById("result").innerText = value; // csak a visszaadott √©rt√©k
  // Ne √°ll√≠tsuk le r√∂gt√∂n, csak ha √∫jraind√≠tjuk gombbal
}

// --- Gomb ---
document.getElementById("scanButton").addEventListener("click", async ()=>{
  document.getElementById("result").innerText = "Kamera akt√≠v ‚Äì olvass be egy k√≥dot!";
  await startCamera();
});

// --- Bet√∂lt√©s ---
loadExcel();
</script>
</body>
</html>
