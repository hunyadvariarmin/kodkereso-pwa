<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K√≥dkeres≈ë</title>
<style>
html, body { margin:0; padding:0; height:100%; font-family: Arial; background:#000; color:white; overflow:hidden; }
#reader { width:100vw; height:100vh; position:fixed; top:0; left:0; background:#000; z-index:0; }
#centerResult { position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); font-size:100px; font-weight:bold; color:#00ff88; text-align:center; z-index:2; }
#bottomOverlay { position:fixed; bottom:0; width:100%; background:rgba(0,0,0,0.7); padding:20px; text-align:center; z-index:2; }
button { background:#007bff; border:none; color:white; font-size:24px; padding:15px 40px; border-radius:12px; cursor:pointer; margin-top:10px; }
button:hover { background:#0056b3; }
#status { font-size:20px; margin-top:10px; color:white; word-wrap:break-word; }
</style>
</head>
<body>

<div id="reader"></div>

<div id="centerResult">Kamera ind√≠t√°sra v√°r...</div>

<div id="bottomOverlay">
  <button id="scanButton">üì∑ √öj beolvas√°s</button>
  <div id="status"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const GITHUB_RAW_URL = "https://raw.githubusercontent.com/hunyadvariarmin/kodkereso-pwa/main/adatok.xlsx";
let data = [];
let html5QrCode;

// --- Excel bet√∂lt√©se ---
async function loadExcel() {
  try {
    const resp = await fetch(GITHUB_RAW_URL);
    if (!resp.ok) throw new Error("Excel bet√∂lt√©si hiba!");
    const buffer = await resp.arrayBuffer();
    const wb = XLSX.read(buffer, {type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    data = XLSX.utils.sheet_to_json(sheet, {header:1});
    console.log("‚úÖ Excel bet√∂ltve:", data.slice(0,5));
  } catch(e) {
    console.error("‚ùå Excel bet√∂lt√©si hiba:", e);
    document.getElementById("centerResult").innerText = "Excel bet√∂lt√©si hiba!";
  }
}

// --- Normaliz√°l√≥ f√ºggv√©ny ---
function normalizeCode(str) {
  if(!str) return "";
  str = String(str).trim().toUpperCase()
    .replace(/\s+/g,'')
    .replace(/[‚Äê-‚Äì‚Äî‚àí]/g,'-')
    .replace(/\\/g,'/')
    .replace(/[^A-Z0-9\-\/]/g,'');
  if(str.includes("/")) str = str.split("/")[0]; // lev√°gja a / ut√°ni r√©szt
  if(/^\d+\.0$/.test(str)) str = str.replace(/\.0$/,'');
  return str;
}

// --- Keres√©s ---
function findValueByCode(code) {
  if(!code || !data.length) return "Nincs tal√°lat!";
  const searchCode = normalizeCode(code);
  console.log("üîπ Normaliz√°lt k√≥d:", searchCode);
  for(let i=1;i<data.length;i++){
    if(!data[i] || data[i].length<2) continue;
    const cellValue = normalizeCode(data[i][0]);
    console.log("üß© √ñsszehasonl√≠t√°s:", cellValue,"==",searchCode);
    if(cellValue === searchCode) return data[i][1];
  }
  return "Nincs tal√°lat!";
}

// --- Kamera ind√≠t√°sa ---
async function startCamera() {
  try {
    if(html5QrCode) {
      await html5QrCode.stop().catch(()=>{});
      html5QrCode.clear();
      html5QrCode = null;
    }
    document.getElementById("reader").innerHTML = "";

    // kis delay, hogy a kamera felold√≥djon
    await new Promise(r => setTimeout(r, 300));

    html5QrCode = new Html5Qrcode("reader");

    await html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: {width: window.innerWidth, height: window.innerHeight} },
      onScanSuccess
    );

    document.getElementById("status").innerText = "Kamera akt√≠v ‚Äì olvass be egy k√≥dot!";
    document.getElementById("centerResult").innerText = "";
  } catch(e) {
    console.error("‚ùå Kamera hiba:", e);
    document.getElementById("status").innerText = "Kamera ind√≠t√°sa nem siker√ºlt!";
  }
}

// --- Beolvas√°s callback ---
function onScanSuccess(decodedText){
  console.log("üì∑ Beolvasott k√≥d (eredeti):", decodedText);
  const value = findValueByCode(decodedText);
  document.getElementById("centerResult").innerText = value;
  document.getElementById("status").innerText = "Beolvas√°s k√©sz ‚Äì nyomj az √öj beolvas√°s gombra";
  html5QrCode.stop().catch(()=>{}); // stop-oljuk a kamer√°t, csak gombbal ind√≠that√≥ √∫jra
}

// --- Gomb ---
document.getElementById("scanButton").addEventListener("click", async ()=>{
  await startCamera();
});

// --- Bet√∂lt√©s ---
loadExcel();
</script>
</body>
</html>
