<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kódkereső</title>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; background:#fdfdfd; }
  #reader { width:100%; height:100vh; }
  #result { position:absolute; top:20px; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.9); padding:20px 40px; font-size:2rem; font-weight:bold; border-radius:12px; z-index:10; }
  #restartBtn { position:absolute; bottom:40px; left:50%; transform:translateX(-50%); padding:25px 60px; font-size:1.6rem; border:none; border-radius:12px; background:#0078ff; color:white; cursor:pointer; z-index:10; }
  #restartBtn:hover { background:#005fcc; }
</style>
</head>
<body>

<div id="reader"></div>
<div id="result"></div>
<button id="restartBtn" disabled>Új beolvasás</button>

<script>
const GITHUB_RAW_URL = "https://raw.githubusercontent.com/hunyadvariarmin/kodkereso-pwa/main/adatok.xlsx";

let data = [];
let html5QrCode;

// --- Normalizáló függvény a hibák kezelésére ---
function normalizeCode(str) {
    if (!str) return "";
    str = String(str).trim().toUpperCase();              // kis/nagybetű eltüntetése
    str = str.replace(/\s+/g, '');                       // minden szóköz eltávolítása
    str = str.replace(/[‐‑–—−]/g, '-');                  // különböző kötőjelek egységesítése
    if (/^\d+\.0$/.test(str)) str = str.replace(/\.0$/, ''); // számok végi .0 eltávolítása
    return str;
}

// --- Javított findValueByCode ---
function findValueByCode(code) {
    if (!code || !data.length) return "Nincs találat!";
    const searchCode = normalizeCode(code);
    for (let i = 1; i < data.length; i++) {
        if (!data[i] || data[i].length < 2) continue;
        let cellValue = normalizeCode(data[i][0]);
        if (cellValue === searchCode) return data[i][1];
    }
    return "Nincs találat!";
}

// --- Kamera indítása ---
async function startScanner() {
    document.getElementById('result').textContent = "";
    document.getElementById('restartBtn').disabled = true;

    if (!html5QrCode) html5QrCode = new Html5Qrcode("reader");
    else try { await html5QrCode.stop(); } catch(e){}

    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: {width: window.innerWidth, height: window.innerHeight} },
        (decodedText) => {
            html5QrCode.stop();
            console.log("Beolvasott kód (eredeti):", decodedText);
            const value = findValueByCode(decodedText);
            document.getElementById("result").textContent = value;
            document.getElementById('restartBtn').disabled = false;
        }
    );
}

// --- Excel betöltése RAW linkről ---
async function loadExcelFromGitHub() {
    try {
        const response = await fetch(GITHUB_RAW_URL);
        const buffer = await response.arrayBuffer();
        const workbook = XLSX.read(buffer, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        console.log("Excel betöltve:", data);
        startScanner();
    } catch(err) {
        alert("Excel betöltése sikertelen: " + err);
    }
}

document.getElementById('restartBtn').addEventListener('click', () => startScanner());

loadExcelFromGitHub();
</script>

</body>
</html>
