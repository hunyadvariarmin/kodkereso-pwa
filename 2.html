<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2</title>
<style>
html, body {
    margin:0; padding:0; height:100%;
    font-family: Arial, sans-serif;
}
body {
    background: url("icons/logo.png") no-repeat center center fixed;
    background-size: cover;
    color: white;
    position: relative;
    overflow: hidden;
}

/* Kamera nézet */
#reader {
    position: fixed; top:0; left:0; width:100vw; height:100vh;
    object-fit: cover; z-index:3; display:none; background:black;
}

/* Számláló */
#centerResult {
    position: fixed;
    top: 6%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 90px;
    font-weight: bold;
    color: #FFD700;
    text-align: center;
    z-index: 2;
    white-space: pre-line;
}

/* Felső gomb (Kód beolvasása) */
#overlay {
    position: fixed;
    bottom: 95px; /* fölötte az alsó gomboknak */
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    max-width: 350px;
    text-align: center;
    z-index: 2;
    display: flex;
    justify-content: center;
}

/* Gombok stílusa */
button {
    width: 100%;
    padding: 15px;
    font-size: 22px;
    color: #FFD700;
    background: rgba(0,0,0,0.4);
    border: 2px solid #FFD700;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}
button:hover {
    background: rgba(255,215,0,0.2);
    transform: scale(1.05);
}

/* Alsó két gomb */
#bottomButtons {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;
    z-index: 2;
    width: 80%;
    max-width: 400px;
    justify-content: center;
}
#bottomButtons button {
    width: 48%;
    padding: 14px 0;
    font-size: 20px;
}

/* Kis tér a két gombcsoport között */
#overlay { margin-bottom: 40px; }

/* Felugró üzenet (auto 2s) */
#alertMessage {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px;
    background-color: rgba(0, 0, 0, 0.7);
    color: #FFD700;
    font-size: 20px;
    border-radius: 12px;
    display: none;
    z-index: 4;
    text-align: center;
}

/* ==== Menü gomb (bal felső sarok) ==== */
#menuBtn {
    position: fixed;
    top: 12px;
    left: 12px;
    z-index: 5;
    width: auto;
    padding: 10px 14px;
    font-size: 22px;       /* ☰ méret */
    color: #FFD700;
    background: rgba(0,0,0,0.45);
    border: 2px solid #FFD700;
    border-radius: 10px;
    cursor: pointer;
}

/* Oldalsó menü + háttér */
#menuOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    z-index: 6;
}
#sideMenu {
    position: absolute;
    top: 0; left: 0;
    width: 78%;
    max-width: 320px;
    height: 100%;
    background: rgba(0,0,0,0.75);
    border-right: 2px solid #FFD700;
    padding: 16px;
    box-sizing: border-box;
}
#sideMenu h3 {
    margin: 0 0 12px 0;
    font-weight: bold;
    color: #FFD700;
    text-align: left;
}
.menuItem {
    width: 100%;
    padding: 7px;           /* KISEBB padding */
    margin-top: 10px;
    font-size: 20px;         /* KISEBB betűméret */
    color: #FFD700;
    background: rgba(0,0,0,0.35);
    border: 2px solid #FFD700;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
}
.menuItem:hover {
    background: rgba(255,215,0,0.15);
    transform: scale(1.02);
}

/* Kézi bevitel modal */
#manualOverlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    z-index: 7;
}
#manualBox {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%,-50%);
    width: min(90%, 420px);
    background: rgba(0,0,0,0.85);
    border: 2px solid #FFD700;
    border-radius: 14px;
    padding: 18px;
    color: #FFD700;
    text-align: center;
}
#manualBox h4 {
    margin: 6px 0 12px 0;
    font-size: 22px;
}
#manualBox input {
    width: 100%;
    padding: 12px 10px;
    font-size: 18px;
    border-radius: 10px;
    border: 1px solid #FFD700;
    outline: none;
    background: rgba(255,255,255,0.1);
    color: #fff;
    box-sizing: border-box;
}
#manualButtons {
    margin-top: 14px;
    display: flex;
    gap: 12px;
    justify-content: center;
}
#manualButtons button {
    width: 48%;
    padding: 12px 0;
    font-size: 18px;
}

/* Kamera nézethez alul Vissza gomb */
#cameraBack {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    width: 60%;
    max-width: 300px;
    z-index: 4;          /* a kameranézet fölé kerül */
    display: none;       /* csak kamera módban látszik */
}
</style>
</head>
<body>

<!-- Menü gomb -->
<button id="menuBtn" aria-label="Menü">☰</button>

<!-- Oldalsó menü -->
<div id="menuOverlay">
  <div id="sideMenu">
    <h3>Menü</h3>
    <div id="menuOrders" class="menuItem">Rendelések</div>
    <div id="menuManual" class="menuItem">Kézi bevitel</div>
  </div>
</div>

<!-- Kézi bevitel modal -->
<div id="manualOverlay">
  <div id="manualBox">
    <h4>Kézi bevitel</h4>
    <input type="text" id="manualInput" placeholder="Írja be a kódot..." autocomplete="off">
    <div id="manualButtons">
      <button id="manualCancel">Mégse</button>
      <button id="manualOk">Mentés</button>
    </div>
  </div>
</div>

<div id="reader"></div>
<div id="centerResult">0/0</div>

<div id="overlay">
    <button id="scanButton">Kód beolvasása</button>
</div>

<div id="bottomButtons">
    <button id="finishButton">Árukiadás befejezése</button>
    <button id="backButton">Vissza</button>
</div>

<!-- Kamera nézet Vissza gomb -->
<div id="cameraBack">
    <button id="cameraBackButton">Vissza</button>
</div>

<!-- Felugró üzenet -->
<div id="alertMessage"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ===== Oldalspecifikus konstansok ===== */
const TOUR = "2";
const XLSX_URL    = "https://raw.githubusercontent.com/hunyadvariarmin/kodkereso-pwa/main/1.xlsx"; // közös fájl
const SCANNED_KEY = `${TOUR}_scannedList`;   // "2_scannedList"
const DONE_KEY    = `done_${TOUR}`;          // "done_2"

/* ===== Állapot ===== */
let data = [];                 // teljes tábla
let allowedCodes = new Set();  // csak C==TOUR sorok A-oszlop kódjai
let html5QrCode;
let totalCount = 0;
let scannedCodes = new Set();
let manualMap = new Map();     // D kód -> ahhoz tartozó A kód(ok) listája

/* Beolvasottak visszatöltése */
{
    const saved = sessionStorage.getItem(SCANNED_KEY);
    if (saved) {
        try { scannedCodes = new Set(JSON.parse(saved)); }
        catch(e){ scannedCodes = new Set(); }
    }
}

/* ===== Segédfüggvények ===== */
function normalizeCode(str) {
    if(!str) return "";
    let s = String(str).trim().toUpperCase()
        .replace(/\s+/g,'')
        .replace(/[‐-–—−]/g,'-')
        .replace(/\\/g,'/')
        .replace(/[^A-Z0-9\-\/]/g,'');
    // Ha a perjeles részt IS számolni akarjátok, hagyd így.
    // Ha le akarod vágni, tedd vissza: if (s.includes("/")) s = s.split("/")[0];
    if (/^\d+\.0$/.test(s)) s = s.replace(/\.0$/,'');
    return s;
}

function showAlert(message) {
    const alertDiv = document.getElementById("alertMessage");
    alertDiv.innerText = message;
    alertDiv.style.display = "block";
    setTimeout(() => { alertDiv.style.display = "none"; }, 2000);
}

function updateCounter() {
    document.getElementById("centerResult").innerText = `${scannedCodes.size}/${totalCount}`;
}

/* ===== Excel betöltése + szűrés a 2-es túrára + D oszlop map ===== */
async function loadExcel() {
    try {
        const resp = await fetch(XLSX_URL);
        const buffer = await resp.arrayBuffer();
        const wb = XLSX.read(buffer, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        data = XLSX.utils.sheet_to_json(sheet, { header: 1 }); // tömb a sorokkal

        allowedCodes.clear();
        manualMap.clear();

        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            const tourVal = row?.[2] != null ? String(row[2]).trim() : ""; // C oszlop

            if (tourVal === TOUR) {
                const aVal = row?.[0]; // A oszlop – csomagszám (kamera)
                const dVal = row?.[3]; // D oszlop – kézi bevitelhez használt kód

                let aCode = null;
                if (aVal != null && String(aVal).trim() !== "") {
                    aCode = normalizeCode(aVal);
                    if (aCode) {
                        allowedCodes.add(aCode); // kamera által olvasható kód
                    }
                }

                if (dVal != null && String(dVal).trim() !== "") {
                    const dCode = normalizeCode(dVal);
                    if (dCode) {
                        if (!manualMap.has(dCode)) {
                            manualMap.set(dCode, []);
                        }
                        manualMap.get(dCode).push(aCode);
                    }
                }
            }
        }

        totalCount = allowedCodes.size;
        updateCounter();
    } catch(e){
        console.error("Excel betöltési hiba:", e);
    }
}

/* ===== Kamera vezérlés ===== */
async function startCamera() {
    const reader = document.getElementById("reader");
    reader.style.display="block";
    document.getElementById("overlay").style.display="none";
    document.getElementById("cameraBack").style.display="block";  // kamera Vissza gomb látszik
    if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
    await html5QrCode.start(
        {facingMode:"environment"},
        {fps:10, qrbox:null},
        onScanSuccess
    );
}

async function stopCamera() {
    if(html5QrCode) {
        await html5QrCode.stop().catch(()=>{});
        html5QrCode.clear();
        html5QrCode = null;
    }
    document.getElementById("reader").style.display="none";
    document.getElementById("overlay").style.display="block";
    document.getElementById("cameraBack").style.display="none";   // kamera Vissza gomb elrejtése
}

/* ===== Beolvasás callback (KAMERA – A oszlop) ===== */
function onScanSuccess(decodedText) {
    const k = normalizeCode(decodedText);

    if (scannedCodes.has(k)) {
        showAlert("Ezt a kódot már olvasta");
        return; // kamera marad
    }
    if (!allowedCodes.has(k)) {
        showAlert("NEM KELL IDE");
        return; // kamera marad
    }

    // Jó kód a 2-es túrához:
    scannedCodes.add(k);
    sessionStorage.setItem(SCANNED_KEY, JSON.stringify([...scannedCodes]));
    updateCounter();

    // sikeres olvasás után álljunk le (ahogy kértétek)
    stopCamera();
}

/* ===== MENÜ logika ===== */
const menuBtn = document.getElementById('menuBtn');
const menuOverlay = document.getElementById('menuOverlay');
const manualOverlay = document.getElementById('manualOverlay');
const manualInput = document.getElementById('manualInput');

menuBtn.addEventListener('click', ()=> {
    // kamera maradhat, ez csak menü
    menuOverlay.style.display = 'block';
});
menuOverlay.addEventListener('click', (e)=>{
    // csak a háttérre kattintva zárjuk
    if (e.target === menuOverlay) menuOverlay.style.display = 'none';
});

// Rendelések
document.getElementById('menuOrders').addEventListener('click', ()=>{
    // Ha lesz külön oldal:
    window.location.href = 'rendelesek.html';
});

// Kézi bevitel
document.getElementById('menuManual').addEventListener('click', ()=>{
    menuOverlay.style.display = 'none';
    manualOverlay.style.display = 'block';
    manualInput.value = "";
    manualInput.focus();
});

// Kézi bevitel gombok
document.getElementById('manualCancel').addEventListener('click', ()=>{
    manualOverlay.style.display = 'none';
});
document.getElementById('manualOk').addEventListener('click', ()=>{
    const value = manualInput.value || "";
    processManualCode(value);
    manualOverlay.style.display = 'none';
});

/* ===== Kézi bevitel (D oszlop) ===== */
function processManualCode(raw) {
    const dCode = normalizeCode(raw);   // kézzel bevitt D kód

    if (!dCode) {
        showAlert("Üres kód!");
        return;
    }

    const aList = manualMap.get(dCode);
    if (!aList || aList.length === 0) {
        // nincs ilyen D kód az aktuális túrában
        showAlert("VEDD KI A TÚRÁBÓL!");
        return;
    }

    // Keresünk olyan sort, amelynek az A oszlop kódja még nincs beolvasva
    let aToSave = null;
    for (const aCode of aList) {
        if (!aCode) continue;                // ha valamiért üres az A
        if (!scannedCodes.has(aCode)) {
            aToSave = aCode;
            break;
        }
    }

    if (!aToSave) {
        // Minden ehhez a D-hez tartozó csomag már be lett olvasva
        // (akár kamerával, akár korábbi kézi bevitelekkel)
        showAlert("Ezt a kódot már olvasta");
        return;
    }

    // Jelöljük késznek ezt a sort: az A oszlop kódját mentjük, mint eddig
    scannedCodes.add(aToSave);
    sessionStorage.setItem(SCANNED_KEY, JSON.stringify([...scannedCodes]));
    updateCounter();
}

/* ===== Gombok eseményei ===== */
document.getElementById("scanButton").addEventListener("click", startCamera);

document.getElementById("cameraBackButton").addEventListener("click", () => {
    // csak kamera bezárása, semmi más
    stopCamera();
});

document.getElementById("finishButton").addEventListener("click", ()=> {
    if (scannedCodes.size < totalCount) {
        sessionStorage.removeItem('2_scannedList');
    } else {
        localStorage.setItem('done_2', 'true');
        window.location.href = "hd.html?done=1&code=2";
    }
});

document.getElementById("backButton").addEventListener("click", () => {
    window.location.href="hd.html";
});

/* Indítás */
loadExcel();
</script>

</body>
</html>
