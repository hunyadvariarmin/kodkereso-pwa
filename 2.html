<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2</title>
<style>
html, body {
    margin:0; padding:0; height:100%;
    font-family: Arial, sans-serif;
}
body {
    background: url("icons/logo.png") no-repeat center center fixed;
    background-size: cover;
    color: white;
    position: relative;
    overflow: hidden;
}

/* Kamera nézet */
#reader {
    position: fixed; top:0; left:0; width:100vw; height:100vh;
    object-fit: cover; z-index:3; display:none; background:black;
}

/* Számláló */
#centerResult {
    position: fixed;
    top: 6%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 90px;
    font-weight: bold;
    color: #FFD700;
    text-align: center;
    z-index: 2;
    white-space: pre-line;
}

/* Felső gomb (Kód beolvasása) */
#overlay {
    position: fixed;
    bottom: 95px; /* fölötte az alsó gomboknak */
    left: 50%;
    transform: translateX(-50%);
    width: 80%;
    max-width: 350px;
    text-align: center;
    z-index: 2;
    display: flex;
    justify-content: center;
}

/* Gombok stílusa */
button {
    width: 100%;
    padding: 15px;
    font-size: 22px;
    color: #FFD700;
    background: rgba(0,0,0,0.4);
    border: 2px solid #FFD700;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}
button:hover {
    background: rgba(255,215,0,0.2);
    transform: scale(1.05);
}

/* Alsó két gomb */
#bottomButtons {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;
    z-index: 2;
    width: 80%;
    max-width: 400px;
    justify-content: center;
}
#bottomButtons button {
    width: 48%;
    padding: 14px 0;
    font-size: 20px;
}

/* Kis tér a két gombcsoport között */
#overlay { margin-bottom: 40px; }

/* ---- Egyedi modál (középre, nagyobb betű, OK gomb) ---- */
#modalOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;             /* JS mutatja/rejti */
    align-items: center;
    justify-content: center;
    z-index: 5;
}
.modalBox {
    background: rgba(0,0,0,0.85);
    border: 2px solid #FFD700;
    border-radius: 14px;
    padding: 24px 28px;
    max-width: 90%;
    text-align: center;
}
.modalMessage {
    color: #FFD700;
    font-size: 26px;           /* nagyobb betűméret */
    line-height: 1.3;
    margin-bottom: 18px;
}
.modalActions button {
    width: auto;
    min-width: 140px;
    padding: 12px 20px;
    font-size: 20px;
}
</style>
</head>
<body>

<div id="reader"></div>
<div id="centerResult">0/0</div>

<div id="overlay">
    <button id="scanButton">Kód beolvasása</button>
</div>

<div id="bottomButtons">
    <button id="finishButton">Árukiadás befejezése</button>
    <button id="backButton">Vissza</button>
</div>

<!-- Egyedi modál -->
<div id="modalOverlay">
  <div class="modalBox">
    <div class="modalMessage" id="modalMessage"></div>
    <div class="modalActions">
      <button id="modalOk">OK</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
/* ===== Oldalspecifikus konstansok ===== */
const TOUR = "2";
const XLSX_URL    = "https://raw.githubusercontent.com/hunyadvariarmin/kodkereso-pwa/main/1.xlsx"; // közös fájl
const SCANNED_KEY = `${TOUR}_scannedList`;   // "2_scannedList"
const DONE_KEY    = `done_${TOUR}`;          // "done_2"

/* ===== Állapot ===== */
let data = [];                 // teljes tábla
let allowedCodes = new Set();  // csak C==TOUR sorok A-oszlop kódjai
let html5QrCode;
let totalCount = 0;
let scannedCodes = new Set();

/* Beolvasottak visszatöltése */
{
    const saved = sessionStorage.getItem(SCANNED_KEY);
    if (saved) {
        try { scannedCodes = new Set(JSON.parse(saved)); }
        catch(e){ scannedCodes = new Set(); }
    }
}

/* ===== Egyedi modál + szkenner pause/resume ===== */
let scannerPaused = false;

function pauseScanner() {
  if (html5QrCode && typeof html5QrCode.pause === "function") {
    html5QrCode.pause(true); // csak a dekódolás áll meg, a kamera kép marad
    scannerPaused = true;
  }
}

function resumeScanner() {
  if (!html5QrCode) return;
  if (typeof html5QrCode.resume === "function") {
    html5QrCode.resume();
  } else {
    // fallback: ha nincs resume(), indítsuk újra a szkennert
    stopCamera().then(startCamera);
  }
  scannerPaused = false;
}

function showModal(msg) {
    document.getElementById('modalMessage').innerText = msg;
    document.getElementById('modalOverlay').style.display = 'flex';
    pauseScanner();
}
function hideModal() {
    document.getElementById('modalOverlay').style.display = 'none';
    if (scannerPaused) resumeScanner();
}
document.getElementById('modalOk').addEventListener('click', hideModal);

/* ===== Segédfüggvények ===== */
function normalizeCode(str) {
    if(!str) return "";
    let s = String(str).trim().toUpperCase()
        .replace(/\s+/g,'')
        .replace(/[‐-–—−]/g,'-')
        .replace(/\\/g,'/')
        .replace(/[^A-Z0-9\-\/]/g,'');
    if (s.includes("/")) s = s.split("/")[0];   // pl. "123/1" -> "123"
    if (/^\d+\.0$/.test(s)) s = s.replace(/\.0$/,'');
    return s;
}

function updateCounter() {
    document.getElementById("centerResult").innerText = `${scannedCodes.size}/${totalCount}`;
}

/* ===== Excel betöltése + szűrés a 2-es túrára ===== */
async function loadExcel() {
    try {
        const resp = await fetch(XLSX_URL);
        const buffer = await resp.arrayBuffer();
        const wb = XLSX.read(buffer, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        data = XLSX.utils.sheet_to_json(sheet, { header: 1 }); // tömb a sorokkal

        allowedCodes.clear();
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            const tourVal = row?.[2] != null ? String(row[2]).trim() : ""; // C oszlop
            if (tourVal === TOUR) {
                const aVal = row?.[0];
                if (aVal != null && String(aVal).trim() !== "") {
                    allowedCodes.add(normalizeCode(aVal));
                }
            }
        }
        totalCount = allowedCodes.size;
        updateCounter();
    } catch(e){
        console.error("Excel betöltési hiba:", e);
    }
}

/* ===== Kamera vezérlés ===== */
async function startCamera() {
    const reader = document.getElementById("reader");
    reader.style.display="block";
    document.getElementById("overlay").style.display="none";
    if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
    await html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:null}, onScanSuccess);
}

async function stopCamera() {
    if(html5QrCode) {
        await html5QrCode.stop().catch(()=>{});
        html5QrCode.clear();
        html5QrCode = null;
    }
    document.getElementById("reader").style.display="none";
    document.getElementById("overlay").style.display="block";
}

/* ===== Beolvasás callback ===== */
function onScanSuccess(decodedText) {
    const k = normalizeCode(decodedText);

    if (scannedCodes.has(k)) {
        showModal("Ezt a csomagot már olvasta");
        return; // kamera kép marad, dekódolás pauzéban
    }
    if (!allowedCodes.has(k)) {
        showModal("NEM KELL IDE");
        return; // kamera kép marad, dekódolás pauzéban
    }

    // Jó kód a 2-es túrához:
    scannedCodes.add(k);
    sessionStorage.setItem(SCANNED_KEY, JSON.stringify([...scannedCodes]));
    updateCounter();

    // sikeres olvasás után álljunk le (ahogy kértétek)
    stopCamera();
}

/* ===== Gombok eseményei ===== */
document.getElementById("scanButton").addEventListener("click", startCamera);

document.getElementById("finishButton").addEventListener("click", ()=> {
    if (scannedCodes.size < totalCount) {
        sessionStorage.removeItem(SCANNED_KEY);
    } else {
        localStorage.setItem(DONE_KEY, 'true');
        window.location.href = "hd.html?done=1&code=" + TOUR;
    }
});

document.getElementById("backButton").addEventListener("click", () => {
    window.location.href="hd.html";
});

/* Indítás */
loadExcel();
</script>

</body>
</html>
