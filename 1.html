<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1</title>
<style>
html, body {
    margin:0; padding:0; height:100%;
    font-family: Arial, sans-serif;
}
body {
    background: url("icons/logo.png") no-repeat center center fixed;
    background-size: cover;
    color: white;
    position: relative;
    overflow: hidden;
}

/* Kamera nézet */
#reader {
    position: fixed; top:0; left:0; width:100vw; height:100vh;
    object-fit: cover; z-index:3; display:none; background:black;
}

/* Számláló */
#centerResult {
    position: fixed;
    top: 6%;
    left: 50%;
    transform: translateX(-50%);
    font-size: 90px;
    font-weight: bold;
    color: #FFD700;
    text-align: center;
    z-index: 2;
    white-space: pre-line;
}

/* Felső gomb (Kód beolvasása) */
#overlay {
    position: fixed;
    bottom: 105px; /* fölötte az alsó gomboknak */
    left: 50%;
    transform: translateX(-50%);
    width: 70%;
    max-width: 350px;
    text-align: center;
    z-index: 2;
    display: flex;
    justify-content: center;
}

/* Gombok stílusa */
button {
    width: 100%;
    padding: 15px;
    font-size: 22px;
    color: #FFD700;
    background: rgba(0,0,0,0.4);
    border: 2px solid #FFD700;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}
button:hover {
    background: rgba(255,215,0,0.2);
    transform: scale(1.05);
}

/* Alsó két gomb */
#bottomButtons {
    position: fixed;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;
    z-index: 2;
    width: 80%;
    max-width: 400px;
    justify-content: center;
}
#bottomButtons button {
    width: 48%;
    padding: 14px 0;
    font-size: 20px;
}

/* Kis tér a két gombcsoport között */
#overlay { margin-bottom: 40px; }
</style>
</head>
<body>

<div id="reader"></div>
<div id="centerResult">0/0</div>

<div id="overlay">
    <button id="scanButton">Kód beolvasása</button>
</div>

<div id="bottomButtons">
    <button id="finishButton">Árukiadás befejezése</button>
    <button id="backButton">Vissza</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const GITHUB_RAW_URL = "https://raw.githubusercontent.com/hunyadvariarmin/kodkereso-pwa/main/1.xlsx";
let data = [];
let html5QrCode;
let totalCount = 0;
let scannedCodes = new Set();

// Betöltjük az eddigi beolvasásokat
if (sessionStorage.getItem('1_scannedList')) {
    scannedCodes = new Set(JSON.parse(sessionStorage.getItem('1_scannedList')));
}

// Excel betöltése
async function loadExcel() {
    try {
        const resp = await fetch(GITHUB_RAW_URL);
        const buffer = await resp.arrayBuffer();
        const wb = XLSX.read(buffer, { type: "array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        totalCount = data.slice(1).reduce((acc,row)=> (row && row[0] && row[0].toString().trim() !== '') ? acc+1 : acc, 0);
        updateCounter();
    } catch(e){ console.error(e); }
}

// Számláló frissítés
function updateCounter() {
    document.getElementById("centerResult").innerText = `${scannedCodes.size}/${totalCount}`;
}

// Normalizálás
function normalizeCode(str) {
    if(!str) return "";
    str = String(str).trim().toUpperCase().replace(/\s+/g,'')
        .replace(/[‐-–—−]/g,'-').replace(/\\/g,'/').replace(/[^A-Z0-9\-\/]/g,'');
    if(str.includes("/")) str = str.split("/")[0];
    if(/^\d+\.0$/.test(str)) str = str.replace(/\.0$/,'');
    return str;
}

// Kód ellenőrzése
function checkCode(code) {
    const searchCode = normalizeCode(code);
    for(let i=1;i<data.length;i++){
        if(data[i] && data[i][0]){
            if(normalizeCode(data[i][0])===searchCode) return true;
        }
    }
    return false;
}

// Kamera indítása
async function startCamera() {
    const reader = document.getElementById("reader");
    reader.style.display="block";
    document.getElementById("overlay").style.display="none";
    if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
    await html5QrCode.start({facingMode:"environment"}, {fps:10, qrbox:null}, onScanSuccess);
}

// Kamera leállítása
async function stopCamera() {
    if(html5QrCode) {
        await html5QrCode.stop().catch(()=>{});
        html5QrCode.clear();
        html5QrCode = null;
    }
    document.getElementById("reader").style.display="none";
    document.getElementById("overlay").style.display="block";
}

// Beolvasás
function onScanSuccess(decodedText){
    const normalized = normalizeCode(decodedText);
    if(checkCode(normalized) && !scannedCodes.has(normalized)) {
        scannedCodes.add(normalized);
        sessionStorage.setItem('1_scannedList', JSON.stringify([...scannedCodes]));
        updateCounter();
    }
    stopCamera();
}

// Gombok eseményei
document.getElementById("scanButton").addEventListener("click", startCamera);

document.getElementById("finishButton").addEventListener("click", ()=>{
    if(scannedCodes.size < totalCount){
        sessionStorage.removeItem('1_scannedList');
    } else {
        localStorage.setItem('done_1','true');
        window.location.href = "hd.html?done=1&code=1";
    }
});

document.getElementById("backButton").addEventListener("click", ()=>{
    window.location.href="hd.html";
});

loadExcel();
</script>
</body>
</html>
