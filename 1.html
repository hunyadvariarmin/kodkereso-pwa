<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1</title>
<style>
html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; overflow:hidden; }
body { background: url("icons/logo.png") no-repeat center center fixed; background-size: cover; color:white; position:relative; }
#reader { position:fixed; top:0; left:0; width:100vw; height:100vh; object-fit:cover; z-index:3; display:none; background-color:black; }
#centerResult { position:fixed; top:6%; left:50%; transform:translateX(-50%); font-size:110px; font-weight:bold; color:#FFD700; text-align:center; z-index:2; }
#overlay { position:fixed; bottom:4%; left:50%; transform:translateX(-50%); width:90%; max-width:500px; text-align:center; z-index:2; display:flex; flex-direction:row; justify-content:space-between; gap:10px; }
button { flex:1; padding:20px; font-size:28px; color:#FFD700; background: rgba(0,0,0,0.4); border:2px solid #FFD700; border-radius:15px; cursor:pointer; transition: all 0.3s ease; }
button:hover { background: rgba(255,215,0,0.2); transform: scale(1.05); }
</style>
</head>
<body>

<div id="reader"></div>
<div id="centerResult"></div>
<div id="overlay">
    <button id="backButton">Vissza</button>
    <button id="finishButton">Árukiadás befejezése</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const EXCEL_URL = "https://raw.githubusercontent.com/hunyadvariarmin/kodkereso-pwa/main/1.xlsx";
let data = [];
let html5QrCode;
let scannedCodes = JSON.parse(sessionStorage.getItem("1_scannedCodes") || "[]");
let totalCount = 0;

const centerResult = document.getElementById("centerResult");
const overlay = document.getElementById("overlay");
const backButton = document.getElementById("backButton");
const finishButton = document.getElementById("finishButton");

// --- Excel betöltése ---
async function loadExcel() {
    try {
        const resp = await fetch(EXCEL_URL);
        const buffer = await resp.arrayBuffer();
        const wb = XLSX.read(buffer, { type:"array" });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        data = XLSX.utils.sheet_to_json(sheet, { header:1 });

        // Összes vonalkód megszámolása az A oszlopban a 2. sortól
        totalCount = data.slice(1).filter(r => r[0] && r[0].toString().trim()!=="").length;

        updateCounter();
    } catch(e){
        console.error("Excel betöltési hiba:", e);
        centerResult.innerText = "Excel betöltési hiba!";
    }
}

// --- Normalizálás ---
function normalizeCode(str){
    if(!str) return "";
    str = String(str).trim().toUpperCase().replace(/\s+/g,'').replace(/[‐-–—−]/g,'-').replace(/\\/g,'/').replace(/[^A-Z0-9\-\/]/g,'');
    if(str.includes("/")) str = str.split("/")[0];
    if(/^\d+\.0$/.test(str)) str = str.replace(/\.0$/,'');
    return str;
}

// --- Számláló frissítése ---
function updateCounter(){
    centerResult.innerText = `${scannedCodes.length}/${totalCount}`;
}

// --- Kamera indítása ---
async function startCamera(){
    overlay.style.display = "none";
    centerResult.innerText = `${scannedCodes.length}/${totalCount}`;
    try {
        if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        document.getElementById("reader").style.display="block";
        await html5QrCode.start(
            {facingMode:"environment"},
            {fps:10, qrbox:null},
            onScanSuccess
        );
    } catch(e){
        console.error("Kamera hiba:", e);
    }
}

// --- Kamera leállítása ---
async function stopCamera(){
    if(html5QrCode){
        await html5QrCode.stop().catch(()=>{});
        html5QrCode.clear();
        html5QrCode = null;
    }
    document.getElementById("reader").style.display="none";
    overlay.style.display="flex";
}

// --- Beolvasás callback ---
function onScanSuccess(decodedText){
    const code = normalizeCode(decodedText);
    let found = false;

    for(let i=1;i<data.length;i++){
        const cell = data[i][0];
        if(cell && normalizeCode(cell.toString())===code){
            if(!scannedCodes.includes(code)){
                scannedCodes.push(code);
                sessionStorage.setItem("1_scannedCodes", JSON.stringify(scannedCodes));
                updateCounter();
            }
            found = true;
            break;
        }
    }

    stopCamera();
    if(!found) alert("A beolvasott kód nem található az Excelben!");
}

// --- Gombok ---
backButton.addEventListener("click", ()=>{
    // vissza HD.html-re, memóriát megtartja
    window.location.href="hd.html";
});

finishButton.addEventListener("click", ()=>{
    if(scannedCodes.length === totalCount){
        // Minden beolvasva, ne töröljük a memóriát
        window.location.href="hd.html?done=1&code=1";
    } else {
        // Még nincs kész, törlés
        sessionStorage.removeItem("1_scannedCodes");
        window.location.href="hd.html";
    }
});

// Indítás
loadExcel();
updateCounter();
</script>
</body>
</html>
