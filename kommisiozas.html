<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kommissiózás</title>
<style>
html, body { margin:0; padding:0; height:100%; font-family: Arial; overflow:hidden; }
body { background: url("icons/logo.png") no-repeat center center fixed; background-size: cover; color: white; }

#reader { 
    width: 100vw; 
    height: 100vh; 
    position: fixed; 
    top: 0; 
    left: 0; 
    z-index: 0; 
    display: none; 
}

#centerResult { 
    position: fixed; 
    top: 15%; /* feljebb */
    left: 50%; 
    transform: translateX(-50%); 
    font-size: 100px; 
    font-weight: bold; 
    color: #FFD700; 
    text-align: center; 
    z-index: 2; 
}

#overlay { 
    position: fixed; 
    bottom: 5%; 
    left: 50%; 
    transform: translateX(-50%);
    width: 80%;
    max-width: 400px;
    text-align: center; 
    z-index: 2; 
    display: flex;
    flex-direction: column;
    gap: 15px;
}

button { 
    width: 100%;
    padding: 20px;
    font-size: 28px;
    color: #FFD700; 
    background: rgba(0,0,0,0.4); 
    border: 2px solid #FFD700; 
    border-radius: 15px; 
    cursor: pointer; 
    transition: all 0.3s ease; 
}
button:hover { background: rgba(255, 215, 0, 0.2); transform: scale(1.05); }
</style>
</head>
<body>

<div id="reader"></div>
<div id="centerResult"></div>
<div id="overlay">
    <button id="mainButton">Kommissiózás kezdése</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const GITHUB_RAW_URL = "https://raw.githubusercontent.com/hunyadvariarmin/kodkereso-pwa/main/adatok.xlsx";
let data = [];
let html5QrCode;
let state = "logo"; // 'logo', 'kamera', 'eredmeny'

async function loadExcel() {
    try {
        const resp = await fetch(GITHUB_RAW_URL);
        if (!resp.ok) throw new Error("Excel betöltési hiba!");
        const buffer = await resp.arrayBuffer();
        const wb = XLSX.read(buffer, {type:"array"});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        data = XLSX.utils.sheet_to_json(sheet, {header:1});
        console.log("✅ Excel betöltve:", data.slice(0,5));
    } catch(e) {
        console.error("❌ Excel betöltési hiba:", e);
        document.getElementById("centerResult").innerText = "Excel betöltési hiba!";
    }
}

function normalizeCode(str) {
    if(!str) return "";
    str = String(str).trim().toUpperCase()
        .replace(/\s+/g,'')
        .replace(/[‐-–—−]/g,'-')
        .replace(/\\/g,'/')
        .replace(/[^A-Z0-9\-\/]/g,'');
    if(str.includes("/")) str = str.split("/")[0];
    if(/^\d+\.0$/.test(str)) str = str.replace(/\.0$/,'');
    return str;
}

function findValueByCode(code) {
    if(!code || !data.length) return "Nincs járaton";
    const searchCode = normalizeCode(code);

    for(let i=1;i<data.length;i++){
        const row = data[i];
        if(row && row.length>=3){
            const szallitolevel = normalizeCode(row[0]);
            if(szallitolevel === searchCode) return row[2];
        }
    }
    for(let i=1;i<data.length;i++){
        const row = data[i];
        if(row && row.length>=3){
            const csomagszam = normalizeCode(row[1]);
            if(csomagszam === searchCode) return row[2];
        }
    }
    return "Nincs járaton";
}

async function startCamera() {
    document.getElementById("reader").style.display = "block";
    document.getElementById("centerResult").innerText = "";
    state = "kamera";
    renderButtons();
    try {
        if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        await html5QrCode.start(
            { facingMode:"environment" },
            { fps:10, qrbox:{width:window.innerWidth,height:window.innerHeight} },
            onScanSuccess
        );
    } catch(e){
        console.error("❌ Kamera hiba:",e);
    }
}

async function stopCamera(){
    if(html5QrCode){
        await html5QrCode.stop().catch(()=>{});
        html5QrCode.clear();
        html5QrCode = null;
    }
    document.getElementById("reader").style.display = "none";
}

function onScanSuccess(decodedText){
    const value = findValueByCode(decodedText);
    document.getElementById("centerResult").innerText = value;
    stopCamera();
    state = "eredmeny";
    renderButtons();
}

function renderButtons(){
    const overlay = document.getElementById("overlay");
    overlay.innerHTML = "";
    if(state === "logo"){
        const btn = document.createElement("button");
        btn.innerText = "Kommissiózás kezdése";
        btn.onclick = startCamera;
        overlay.appendChild(btn);
    } else if(state === "kamera"){
        // Kamera alatt nincs gomb
    } else if(state === "eredmeny"){
        const scanBtn = document.createElement("button");
        scanBtn.innerText = "Kód beolvasása";
        scanBtn.onclick = startCamera;
        overlay.appendChild(scanBtn);

        const endBtn = document.createElement("button");
        endBtn.innerText = "Kommissiózás befejezése";
        endBtn.onclick = () => { window.location.href="index.html"; };
        overlay.appendChild(endBtn);
    }
}

loadExcel().then(renderButtons);
</script>
</body>
</html>
