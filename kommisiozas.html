<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kommisiózás</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: url('logo.png') no-repeat center center fixed;
  background-size: cover;
  font-family: Arial;
  color: white;
  overflow: hidden;
}

/* Kamera kép */
#reader {
  width: 100vw;
  height: 100vh;
  position: fixed;
  top: 0;
  left: 0;
  display: none;
  z-index: 1;
}

/* Kamera fölé helyezett vissza gomb */
#backButton {
  position: fixed;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(120, 120, 120, 0.6);
  color: white;
  border: none;
  padding: 14px 40px;
  border-radius: 12px;
  font-size: 20px;
  cursor: pointer;
  z-index: 10;
  display: none;
}

#backButton:hover {
  background: rgba(160, 160, 160, 0.8);
}

/* Visszaadott érték */
#centerResult {
  position: fixed;
  top: 35%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-weight: bold;
  color: #ffcc00;
  text-align: center;
  z-index: 5;
  white-space: pre-line;
  text-shadow: 0 0 10px rgba(0,0,0,0.7);
}

/* Kis méret, ha nincs járaton */
.small {
  font-size: 40px;
}

/* Nagy méret, ha szám */
.large {
  font-size: 120px;
  color: #00ff88;
}

/* Alul a gombok */
#buttonContainer {
  position: fixed;
  bottom: 60px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 5;
  text-align: center;
}

button.action {
  background: rgba(0,0,0,0.6);
  color: white;
  border: 2px solid #ffcc00;
  font-size: 24px;
  padding: 15px 40px;
  border-radius: 12px;
  cursor: pointer;
  margin: 10px;
}

button.action:hover {
  background: rgba(255,255,255,0.1);
}
</style>
</head>
<body>

<div id="reader"></div>
<button id="backButton">Vissza</button>

<div id="centerResult"></div>

<div id="buttonContainer">
  <button id="scanStart" class="action">Kód beolvasása</button>
  <button id="endButton" class="action">Kommisiózás befejezése</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
const GITHUB_RAW_URL = "https://raw.githubusercontent.com/hunyadvariarmin/kodkereso-pwa/main/adatok.xlsx";
let data = [];
let html5QrCode;

// --- Excel betöltése ---
async function loadExcel() {
  try {
    const resp = await fetch(GITHUB_RAW_URL);
    if (!resp.ok) throw new Error("Excel betöltési hiba!");
    const buffer = await resp.arrayBuffer();
    const wb = XLSX.read(buffer, {type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    data = XLSX.utils.sheet_to_json(sheet, {header:1});
    console.log("✅ Excel betöltve:", data.slice(0,5));
  } catch(e) {
    console.error("❌ Excel betöltési hiba:", e);
  }
}

// --- Normalizáló függvény ---
function normalizeCode(str) {
  if(!str) return "";
  str = String(str).trim().toUpperCase()
    .replace(/\s+/g,'')
    .replace(/[‐-–—−]/g,'-')
    .replace(/\\/g,'/')
    .replace(/[^A-Z0-9\-\/]/g,'');
  if(str.includes("/")) str = str.split("/")[0];
  if(/^\d+\.0$/.test(str)) str = str.replace(/\.0$/,'');
  return str;
}

// --- Keresés (A és B oszlop alapján) ---
function findValueByCode(code) {
  if(!code || !data.length) return "Nincs járaton";
  const searchCode = normalizeCode(code);
  for(let i=1; i<data.length; i++) {
    if(!data[i]) continue;
    const sl = normalizeCode(data[i][0]);
    const csomag = normalizeCode(data[i][1]);
    if(sl === searchCode || csomag === searchCode) {
      return data[i][2] || "Nincs járaton";
    }
  }
  return "Nincs járaton";
}

// --- Kamera indítása ---
async function startCamera() {
  try {
    document.getElementById("reader").style.display = "block";
    document.getElementById("backButton").style.display = "block";
    document.getElementById("buttonContainer").style.display = "none";
    document.getElementById("centerResult").innerText = "";

    if(!html5QrCode){
      html5QrCode = new Html5Qrcode("reader");
    }

    await html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: { width: window.innerWidth, height: window.innerHeight } },
      onScanSuccess
    );
  } catch(e) {
    console.error("❌ Kamera hiba:", e);
  }
}

// --- Beolvasás callback ---
async function onScanSuccess(decodedText) {
  const value = findValueByCode(decodedText);
  await html5QrCode.stop().catch(()=>{});
  document.getElementById("reader").style.display = "none";
  document.getElementById("backButton").style.display = "none";
  document.getElementById("buttonContainer").style.display = "block";
  document.getElementById("centerResult").className = 
    (value === "Nincs járaton") ? "small" : "large";
  document.getElementById("centerResult").innerText = value;
}

// --- Gomb események ---
document.getElementById("scanStart").addEventListener("click", startCamera);
document.getElementById("backButton").addEventListener("click", async ()=>{
  await html5QrCode.stop().catch(()=>{});
  document.getElementById("reader").style.display = "none";
  document.getElementById("backButton").style.display = "none";
  document.getElementById("buttonContainer").style.display = "block";
});
document.getElementById("endButton").addEventListener("click", ()=>{
  window.location.href = "index.html";
});

// --- Betöltés ---
loadExcel();
</script>
</body>
</html>
